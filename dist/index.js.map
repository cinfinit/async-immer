{"version":3,"sources":["../src/core/container.ts","../src/core/asyncProduce.ts","../src/engine/immerEngine.ts"],"sourcesContent":["// src/core/container.ts\n\nexport class StateContainer<S> {\n  state: S\n  version: number\n\n  constructor(initialState: S) {\n    this.state = initialState\n    this.version = 0\n  }\n}\n","import type { DraftEngine } from \"../engine/DraftEngine\"\nimport type { AsyncProduceResult } from \"../types\"\nimport { StateContainer } from \"./container\"\n\n\nexport async function asyncProduce<S, D extends S = S>(\n  container: StateContainer<S>,\n  recipe: (draft: D) => Promise<void> | void,\n  engine: DraftEngine<S, D>\n): Promise<AsyncProduceResult<S>> {\n  const baseVersion = container.version\n  const baseState = container.state\n\n  const draft = engine.createDraft(baseState)\n\n  try {\n    await recipe(draft)\n  } catch (err) {\n    engine.abortDraft?.(draft)\n    return {\n      state: container.state,\n      status: \"aborted\",\n      version: container.version\n    }\n  }\n\n  // ðŸš¨ Commit gate (race + stale protection)\n  if (container.version !== baseVersion) {\n    engine.abortDraft?.(draft)\n    return {\n      state: container.state,\n      status: \"aborted\",\n      version: container.version\n    }\n  }\n\n  // âœ… Atomic commit\n  const nextState = engine.finishDraft(draft)\n  container.state = nextState\n  container.version++\n\n  return {\n    state: nextState,\n    status: \"committed\",\n    version: container.version\n  }\n}\n","// src/engine/immerEngine.ts\n\nimport { createDraft, finishDraft } from \"immer\"\nimport type { DraftEngine } from \"./DraftEngine\"\n\nexport const immerEngine: DraftEngine = {\n  createDraft(base) {\n    return createDraft(base)\n  },\n  finishDraft(draft) {\n    return finishDraft(draft)\n  }\n}\n"],"mappings":";AAEO,IAAM,iBAAN,MAAwB;AAAA,EAI7B,YAAY,cAAiB;AAC3B,SAAK,QAAQ;AACb,SAAK,UAAU;AAAA,EACjB;AACF;;;ACLA,eAAsB,aACpB,WACA,QACA,QACgC;AATlC;AAUE,QAAM,cAAc,UAAU;AAC9B,QAAM,YAAY,UAAU;AAE5B,QAAM,QAAQ,OAAO,YAAY,SAAS;AAE1C,MAAI;AACF,UAAM,OAAO,KAAK;AAAA,EACpB,SAAS,KAAK;AACZ,iBAAO,eAAP,gCAAoB;AACpB,WAAO;AAAA,MACL,OAAO,UAAU;AAAA,MACjB,QAAQ;AAAA,MACR,SAAS,UAAU;AAAA,IACrB;AAAA,EACF;AAGA,MAAI,UAAU,YAAY,aAAa;AACrC,iBAAO,eAAP,gCAAoB;AACpB,WAAO;AAAA,MACL,OAAO,UAAU;AAAA,MACjB,QAAQ;AAAA,MACR,SAAS,UAAU;AAAA,IACrB;AAAA,EACF;AAGA,QAAM,YAAY,OAAO,YAAY,KAAK;AAC1C,YAAU,QAAQ;AAClB,YAAU;AAEV,SAAO;AAAA,IACL,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,SAAS,UAAU;AAAA,EACrB;AACF;;;AC5CA,SAAS,aAAa,mBAAmB;AAGlC,IAAM,cAA2B;AAAA,EACtC,YAAY,MAAM;AAChB,WAAO,YAAY,IAAI;AAAA,EACzB;AAAA,EACA,YAAY,OAAO;AACjB,WAAO,YAAY,KAAK;AAAA,EAC1B;AACF;","names":[]}